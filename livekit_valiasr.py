"""
ุนุงูู ุตูุช ูพุฎุด ุชุงุช (ูุณุฎู ูฺู ุจููุฑ ุฒูฺฏุงู)
========================================
ุนุงูู ฺฏูุชโูฺฏู ุตูุช ุจุฑุง ูุนุฑูุ ุชูุถุญ ู ุซุจุช ุณูุงุฑุด ูุญุตููุงุช ุจููุฑ ุฒูฺฏุงู:
ููุงูโุ ุฏุณโุ ุจุดูุงุจ ู ุณุงุฑ ุงููุงู ุฎุงูฺฏ ู ูพุฐุฑุง.

ุฒุฑุณุงุฎุช: OpenAI STT (fa) + Silero VAD + OpenAI TTS (sage) + OpenAI LLM
"""

from dotenv import load_dotenv
import os
import json
from datetime import datetime

from livekit import agents
from livekit.agents import Agent
from livekit.plugins import openai, silero


# ---------------------- ENV ----------------------
load_dotenv(".env")


# ======================================================
# ฺฉูุงุณ ุงุตู ุนุงูู ูพุฎุด ุชุงุช
# ======================================================
class TatShopAgentFA(Agent):
    """ุนุงูู ูุฑูุด ู ูุดุงูุฑ ุจููุฑุฌุงุช ูพุฎุด ุชุงุช ุจุง ุชูุฑฺฉุฒ ุจุฑ ุจุฑูุฏ ุฒูฺฏุงู."""

    def __init__(self):
        super().__init__(
            instructions=(
              "ุดูุง ูุฑูุดูุฏูโ ู ูุดุงูุฑ ูพุฎุด ุชุงุช ูุณุชุฏ ฺฉู ุฏุฑ ุฒูููโ ูุญุตููุงุช ุจููุฑ ุฒูฺฏุงู ูุนุงูุช ูโฺฉูุฏ. "
              "ุจููุฑ ุฒูฺฏุงู ุงุฒ ุจูุชุฑู ููุน ุจููุฑ ุงุฑุงู ุงุณุช โ ุดูุงูุ ููุงูู ู ุจุง ุทุฑุงุญ ุจุณุงุฑ ุฒุจุง. "
              "ุจุง ูุดุชุฑ ุจู ุฒุจุงู ูุงุฑุณุ ูุญู ูุญุชุฑูุงูู ู ุตูู ุตุญุจุช ฺฉูุฏ. "
              "ููุท ุฏุฑุจุงุฑูโ ูุญุตููุงุช ุฒุฑ ุชูุถุญ ุจุฏูุฏ ู ุงฺฏุฑ ูุดุชุฑ ฺฉุงูุง ุฎุงุฑุฌ ุงุฒ ุขู ุฎูุงุณุชุ "
              "ููุฏุจุงูู ุจฺฏูุฏ ยซูุชุฃุณููุ ฺูู ูุญุตูู ุฏุฑ ููุฑุณุช ูุง ูุณุชยป. "
              "ูุญุตููุงุช ููุฌูุฏ ุนุจุงุฑุชูุฏ ุงุฒ:\n"
              "ฑ. ููุงู ุฒูฺฏุงู ุงูพุฑุง ุฏุณ ฺฏุฑุฏ ุฌูุช ฺฉุงุฏู ถ ุฌูุช\n"
              "ฒ. ููุงู ุฒูฺฏุงู ุงุฑฺฉุฏู ฺฉุงุณู\n"
              "ณ. ููุงู ุฒูฺฏุงู ุงุฑุบูุงู\n"
              "ด. ุฒูฺฏุงู ุทูุง ููุงู ฑธ ุชุง\n"
              "ต. ุฒูฺฏุงู ุชุงุชุงูฺฉ ุฏุณ ฺฉุงุฏู\n"
              "ถ. ุฒูฺฏุงู ููุงูุฑ ููุงู ุจููุฏ\n"
              "ุฏุฑ ูุนุฑู ูุฑ ูุญุตููุ ุจู ุฌูุณ ุจููุฑุ ฺฉูุช ุณุงุฎุชุ ุฒุจุง ุทุฑุญุ ฺฉุงุฑุจุฑุฏ ู ุจุณุชูโุจูุฏ ุงุดุงุฑู ฺฉู. "
              "ุฏุฑ ุตูุฑุช ุนูุงูู ูุดุชุฑุ ุงุทูุงุนุงุช ุณูุงุฑุด ุจฺฏุฑ ู ุฎุฑุฏ ุฑุง ุจุง ุฌูุนโุจูุฏ ูุญุชุฑูุงูู ุซุจุช ฺฉู."
            )
        )

        self.state = "GREETING"
        self.customer = {"name": None, "requests": [], "chosen_product": None, "summary": None}

        # ููุฑุณุช ูุญุตููุงุช ูพุฎุด ุชุงุช (ุจููุฑ ุฒูฺฏุงู)
        self.products = {
            "ููุงู ุฒูฺฏุงู ุงูพุฑุง ุฏุณ ฺฏุฑุฏ ุฌูุช ฺฉุงุฏู 6 ุฌูุช": {
                "desc": "ุจููุฑ ุฒูฺฏุงู ุจุง ุทุฑุญ ุงูพุฑุง ฺฉูุงุณฺฉุ ุฏุณ ฺฏุฑุฏ ู ุจุณุชูโุจูุฏ ฺฉุงุฏู ถ ุฌูุชุ ุดูุงูุช ุจุงูุง ู ูุจู ููุงูู.",
                "price": "ุญุฏูุฏ ถตฐ ูุฒุงุฑ ุชููุงู",
            },
            "ููุงู ุฒูฺฏุงู ุงุฑฺฉุฏู ฺฉุงุณู": {
                "desc": "ุณุช ุฒุจุง ุจุง ุทุฑุญ ฺฏู ุงุฑฺฉุฏูุ ุชุฑฺฉุจ ููุงู ู ฺฉุงุณู ููุงููฺฏ ุจุง ุจููุฑ ุถุฎู ู ููุงููุ ุฌูููโ ุฎุงุต ุฑู ูุฒ ูพุฐุฑุง.",
                "price": "ุญุฏูุฏ ดธฐ ูุฒุงุฑ ุชููุงู",
            },
            "ููุงู ุฒูฺฏุงู ุงุฑุบูุงู": {
                "desc": "ุทุฑุญ ุณุงุฏู ู ุดูุงู ุจุง ุฑูฺฏ ุทุจุน ุจููุฑ ุงุฑุบูุงูุ ููุงูู ุฏุฑ ุจุฑุงุจุฑ ุฎุท ู ุฎุดุ ููุงุณุจ ูุตุฑู ุฑูุฒุงูู ู ูุฌุงูุณ.",
                "price": "ุญุฏูุฏ ณนฐ ูุฒุงุฑ ุชููุงู",
            },
            "ุฒูฺฏุงู ุทูุง ููุงู 18 ุชุง": {
                "desc": "ุณุช ฺฉุงูู ฑธ ุนุฏุฏ ุงุฒ ุจููุฑ ุฒูฺฏุงู ุจุง ุชุฒุฆู ุทูุงุ ููุงุณุจ ูพุฐุฑุง ุฑุณู ู ูุฏูโ ุฎุงุต.",
                "price": "ุญุฏูุฏ นตฐ ูุฒุงุฑ ุชููุงู",
            },
            "ุฒูฺฏุงู ุชุงุชุงูฺฉ ุฏุณ ฺฉุงุฏู": {
                "desc": "ุฏุณ ุจุฒุฑฺฏ ุจููุฑ ุฒูฺฏุงู ุจุง ุทุฑุญ ูุฏุฑู ุชุงุชุงูฺฉุ ูุฏูโุง ุดฺฉ ุจุง ุจุณุชูโุจูุฏ ฺฉุงุฏู ููุงูู.",
                "price": "ุญุฏูุฏ ทฒฐ ูุฒุงุฑ ุชููุงู",
            },
            "ุฒูฺฏุงู ููุงูุฑ ููุงู ุจููุฏ": {
                "desc": "ููุงู ุจููุฏ ุจููุฑ ููุงูุฑ ุจุง ููุด ุจุฑุฌุณุชูโ ฺฏูโูุง ุฒุจุงุ ุดูุงูุ ุฎูุดโุฏุณุช ู ููุงุณุจ ููุดุฏูโูุง ุฎูฺฉ.",
                "price": "ุญุฏูุฏ ตฒฐ ูุฒุงุฑ ุชููุงู",
            },
        }

    # ---------------- ุฎูุงุตูโุณุงุฒ ----------------
    async def summarize_text(self, ctx, text):
        if not text:
            return None
        prompt = f"ุฎูุงุตูโุง ูุญุชุฑูุงูู ุงุฒ ูฺฉุงููู ูุฑูุด ุจููุฑ ุฒูฺฏุงู ุฏุฑ ูพุฎุด ุชุงุช ุจููุณ:\n{text}"
        result = await ctx.session.llm.respond(prompt)
        return result.text.strip()

    # ---------------- ุดุฑูุน ฺฏูุชโูฺฏู ----------------
    async def on_start(self, ctx):
        greeting = (
            "ุณูุงู ู ุนุฑุถ ุงุญุชุฑุงู ๐ธ ุฎูุดโุขูุฏุฏ ุจู ูพุฎุด ุชุงุช โ ูุง ูุฌููุนูโุง ุงุฒ ุจูุชุฑู ุจููุฑูุง ุฒูฺฏุงู ุฑุง "
            "ุจุง ุทุฑุงุญโูุง ูุชููุน ูุซู ุงูพุฑุงุ ุงุฑุบูุงูุ ุงุฑฺฉุฏูุ ุทูุง ู ุชุงุชุงูฺฉ ุฏุงุฑู. "
            "ูุงูุฏ ุฏุฑุจุงุฑูโ ฺฉุฏุงู ูุฏู ุจุดุชุฑ ุจุฏุงูุฏุ"
        )
        print(f"๐ฃ ุนุงูู ูโฺฏูุฏ: {greeting}")
        await ctx.session.say(greeting, rate=0.9)
        self.state = "OFFERING"

    # ---------------- ูพุงุณุฎโฺฏู ุจู ูุดุชุฑ ----------------
    async def on_user_spoke(self, ctx, text: str):
        text = text.strip()
        if not text:
            return

        found = None
        for name in self.products:
            if name in text:
                found = name
                break

        if found:
            product = self.products[found]
            msg = (
                f"{found} ุงุฒ ุจููุฑ ุฒูฺฏุงู ุณุงุฎุชู ุดุฏู ฺฉู ุดูุงูุช ู ุฏูุงู ุจุงูุง ุฏุงุฑุฏ. "
                f"{product['desc']} "
                f"ููุช ุขู {product['price']} ุงุณุช. "
                "ูโุฎูุงูุฏ ููู ูุฏู ุฑุง ุณูุงุฑุด ุจุฏููุ"
            )
            await ctx.session.say(msg, rate=0.9)
            self.customer["requests"].append(found)
            self.state = "ORDER_REQUEST"

        elif "ุณูุงุฑุด" in text or "ูโุฎูุงู" in text:
            await ctx.session.say("ูุทูุงู ูุงู ุฏูู ูุญุตูู ุจููุฑ ุฒูฺฏุงู ููุฑุฏูุธุฑ ุฑุง ุจูุฑูุงุฏ.", rate=0.9)

        elif self.state == "ORDER_REQUEST":
            self.customer["chosen_product"] = text
            confirm = (
                f"ุฎู ุนุงูุ ุณูุงุฑุด ุดูุง ุจุฑุง ยซ{text}ยป ุซุจุช ุดุฏ. "
                "ูุทูุงู ุชุนุฏุงุฏ ููุฑุฏ ูุธุฑ ุฑุง ูู ุจูุฑูุงุฏ ุชุง ูุงฺฉุชูุฑ ุขูุงุฏู ุดูุฏ."
            )
            await ctx.session.say(confirm, rate=0.9)
            self.state = "ORDER_CONFIRM"

        elif self.state == "ORDER_CONFIRM":
            self.customer["requests"].append(text)
            closing = (
                "ุชุดฺฉุฑ ุงุฒ ุฎุฑุฏุชูู ๐ท ุณูุงุฑุด ุดูุง ุจุง ููููุช ุซุจุช ุดุฏ ู ููฺฉุงุฑุงู ูพุฎุด ุชุงุช ุจูโุฒูุฏ ุจุฑุง ููุงููฺฏ ุชูุงุณ ูโฺฏุฑูุฏ. "
                "ุจููุฑ ุฒูฺฏุงู ุจุง ุดูุงูุช ู ุฏูุงู ุนุงูุ ูุฒ ุดูุง ุฑุง ุฒุจุงุชุฑ ุฎูุงูุฏ ฺฉุฑุฏ!"
            )
            await ctx.session.say(closing, rate=0.9)
            await self.save_summary(ctx)
            self.state = "CLOSE"

        else:
            await ctx.session.say("ูุชุฃุณููุ ฺูู ูุญุตูู ุฏุฑ ูุณุช ุจููุฑ ุฒูฺฏุงู ูพุฎุด ุชุงุช ูุฌูุฏ ูุฏุงุฑุฏ.", rate=0.9)

    # ---------------- ุฐุฎุฑู ุฎูุงุตู ูฺฉุงููู ----------------
    async def save_summary(self, ctx):
        summary_text = json.dumps(self.customer, ensure_ascii=False, indent=4)
        summarized = await self.summarize_text(ctx, summary_text)

        data = {
            "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "conversation": self.customer,
            "summary": summarized,
        }

        with open("tat_shop_session_fa.json", "w", encoding="utf-8") as f:
            json.dump(data, f, indent=4, ensure_ascii=False)

        print("โ ุฎูุงุตู ุฎุฑุฏ ุฏุฑ ูุงู tat_shop_session_fa.json ุฐุฎุฑู ุดุฏ.")


# ======================================================
# ENTRYPOINT
# ======================================================
async def entrypoint(ctx: agents.JobContext):
    """ุฑุงูโุงูุฏุงุฒ ฺฉุงูู ุนุงูู ุตูุช ูพุฎุด ุชุงุช (ุจููุฑ ุฒูฺฏุงู)."""
    session = agents.AgentSession(
        stt=openai.STT(model="gpt-4o-mini-transcribe", language="fa"),
        llm=openai.LLM(model=os.getenv("LLM_CHOICE", "gpt-4.1-mini")),
        tts=openai.TTS(voice="sage"),
        vad=silero.VAD.load(),
    )
    await session.start(room=ctx.room, agent=TatShopAgentFA())


# ======================================================
# ุงุฌุฑุง ุนุงูู
# ======================================================
if __name__ == "__main__":
    agents.cli.run_app(agents.WorkerOptions(entrypoint_fnc=entrypoint))
